<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>Remote administration node - reverse SSH setup</title>
    <link rel="stylesheet" type="text/css" href="https://www.ivankovic.me/css/style.css" media="screen">
    <link rel="icon" href="/favicon.ico">
    <meta charset="utf-8">
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

    <script>
      function toggle() {
        menu = document.getElementById('menu')
        menu.style.display = (menu.style.display == 'none' || menu.style.display == '' ? 'block' : 'none')
      }
    </script>
  </head>
  <body>
    <div
       id="main"
       
    >


<header>
  <nav>
    <a href="/">Ivankovic.Me</a>
    <span id="subpages">
      <a href="/photography/">Photography</a>
      <a href="/blog/" >Blog</a>
      <a href="/contact/" >Contact</a>
      <a href="/about/" >About</a>
      <a href="/privacy/" >Privacy</a>
    </span>
  </nav>
</header>


<div id="content" style="display: block; padding-left: 64px;" itemscope itemtype="https://schema.org/BlogPosting">
  

<h1 id="remote-administration-node-reverse-ssh-setup">Remote administration node - reverse SSH setup</h1>

<p>Sometimes you just need to remotely administer a network 1000 kilometers away. <a href="http://tvtropes.org/pmwiki/pmwiki.php/Main/CrazyPrepared">Thinking ahead</a> can save you a lot of headache in this situation.</p>

<p>A R-PI node connected to the remote network can open a <a href="http://en.wikipedia.org/wiki/Reverse_connection">reverse SSH tunnel</a> back to you.</p>

<h2 id="reverse-ssh-tunnel-setup">Reverse SSH tunnel setup</h2>

<p>Because one of the devices is in a physically remote location you <strong>should not reuse any cryptographic materials</strong>.</p>

<p>You should create a new restricted user on the server. When creating the user, remember to <strong>change the login shell to <code>/bin/false</code></strong>. This user is only used for port forwarding so there’s no need for a login shell, and if the ssh key ever falls into the wrong hands, the damage they can do is limited.</p>

<p>On the remote device, <a href="https://wiki.archlinux.org/index.php/SSH_Keys#Generating_an_SSH_key_pair">create a new SSH keypair</a>. Because you will not be there to type the password, the key should be passwordless. Because of this potential vulnerability, this SSH key should only ever be used for the newly created locked down user. You can now copy this key to the newly created user on the server. It’s also probably a good idea to have a key that works the other way, allowing you to connect to the remote device without a password.</p>

<p>Once you have copied the keys, try connecting to the server from the remote device. If this works, you can set up an entry in the <code>~/.ssh/config</code> file to simplify further config. The important options are:</p>

<ol>
<li><p><code>RemoteForward</code> - This sets up port forwarding. The format is <code>&lt;port on server&gt; localhost:&lt;ssh port&gt;</code>. For <code>&lt;port on server&gt;</code> you should choose a high enough, random port. This port <strong>doesn’t need to be exposed externally</strong>. You can safely <a href="http://www.ivankovic.me/blog/2013/11/09/basic-network-security-setup-for-rpi.html">firewall</a> them on both the server and the remote device.</p></li>

<li><p><code>ServerAliveInterval</code> - Because this is a long living connection with no traffic, it’s good to send a null packet every now and then. Once every 60 seconds will do.</p></li>

<li><p><code>ServerAliveCountMax</code> - On the other hand, if some (for example 2) of these null packets don’t make it, assume that the connection is dead.</p></li>
</ol>

<p>Finally, try out your config. Initiate the SSH tunnel from the remote device. You should now be able to SSH to <code>localhost:&lt;port on server&gt;</code> on the server itself and get the login prompt for the remote device.</p>

<h2 id="automatic-ssh-on-startup">Automatic SSH on startup</h2>

<p><a href="http://www.harding.motd.ca/autossh/">autossh</a> is a nice little program that will start an SSH session and monitor it, restarting it as necessary. There’s a <a href="https://packages.debian.org/wheezy/autossh">Debian package</a>.</p>

<p>You can add it to <code>rc.local</code> to make sure it start on every boot. A simple <code>autossh -M 0 -f -N &lt;host&gt;</code> will do. For extra points, use <code>su -c autossh -M 0 -f -N &lt;host&gt; &lt;username&gt; &amp;</code> to run it as an unprivileged user.</p>

</div>

    </div>
  </body>
</html>

